<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performans Paneli</title>
    
    <meta name="theme-color" content="#1e293b">
    <meta name="description" content="Öğretmenler için Öğrenci Performans Değerlendirme Paneli">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase Kütüphaneleri -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .cool-title { font-family: 'Exo 2', sans-serif; background: -webkit-linear-gradient(45deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .teacher-info, .confirm-modal, .auth-form { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* Tarayıcının varsayılan number input oklarını gizle */
        input[type='number']::-webkit-inner-spin-button, 
        input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        .pdf-page-break { page-break-after: always; }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div id="root" class="w-full max-w-7xl"></div>
    
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, Fragment, useCallback, memo } = React;
        
        // Firebase yapılandırması
        const firebaseConfig = {
            apiKey: "AIzaSyBn2f7sG_tb4AoCtx0AR1d3rw9OfhiW0Hc",
            authDomain: "performanspaneli.firebaseapp.com",
            projectId: "performanspaneli",
            storageBucket: "performanspaneli.appspot.com", 
            messagingSenderId: "884074936264",
            appId: "1:884074936264:web:0645577f7c66fecce8f2fd",
            measurementId: "G-4P30W8GEYJ"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.analytics();
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Raporlama için Kriterler
        const IN_CLASS_CRITERIA = {
            derse_zamaninda_gelme: { label: 'Derse zamanında gelme', max: 5 }, derse_devam_ilgi_saygi: { label: 'Derse devam, ilgi ve saygı', max: 10 }, arac_gerec: { label: 'Ders araç ve gereçlerini getirme', max: 10 }, ilgi_not_tutma: { label: 'Derse ilgi ve not tutma', max: 10 }, soru_cevap: { label: 'Soru ve önerilere cevap verme', max: 10 }, elestirel_dusunme: { label: 'Eleştirel düşünerek soru sorma', max: 10 }, uygulama_istekli: { label: 'Uygulamalara katılmaya istekli olma', max: 10 }, turkce_kullanimi: { label: 'Türkçeyi doğru kullanma ve olumlu davranış', max: 10 }, on_hazirlik: { label: 'Konuya ön hazırlık yaparak gelme', max: 15 }, odev_zamaninda: { label: 'Ödevlerini zamanında yapma', max: 10 }
        };
        const PERFORMANCE_TASK_CRITERIA = {
            ogretmenle_gorusme: { label: 'Öğretmenle düzenli görüşme ve önerileri dikkate alma', max: 5 }, plan_yapma: { label: 'Ödeve uygun plan yapma ve bu plana göre ödevini hazırlama', max: 5 }, bilgi_dogruluk: { label: 'Bilgilerin doğruluğu ve özgünlüğü', max: 10 }, kavram_anlatma: { label: 'Temel kavramları anlatma, konunun özünü ifade etme', max: 15 }, sunum_hakimiyet: { label: 'Ödevi sunma ve konuya hakimiyet', max: 25 }, materyal_destek: { label: 'Yeterli materyalle (poster, grafik vb.) destekleme', max: 10 }, anlasilir_yazma: { label: 'Anlaşılır yazma ve dilbilgisi kurallarına uyma', max: 10 }, kaynak_kullanma: { label: 'Farklı kaynaklardan yararlanma ve belirtme', max: 10 }, zamaninda_teslim: { label: 'Ödevi zamanında teslim etme', max: 10 }
        };

        // İkonlar
        const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const MinusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const UploadCloudIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const NoteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const ClassesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>;
        const SaveIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const UndoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v6h6"/><path d="M21 13a9 9 0 1 1-4.53-7.83"/></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const BookIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>;
        
        const focusClasses = "focus:outline-none focus:ring-2 focus:ring-blue-500";

        function AuthScreen() {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [isLogin, setIsLogin] = useState(true); const [error, setError] = useState(''); const [loading, setLoading] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); setError(''); setLoading(true); if (isLogin) { auth.signInWithEmailAndPassword(email, password).catch(err => setError(err.message)).finally(() => setLoading(false)); } else { auth.createUserWithEmailAndPassword(email, password).catch(err => setError(err.message)).finally(() => setLoading(false)); } };
            return ( <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl shadow-2xl shadow-blue-500/10 p-8 text-white w-full max-w-md mx-auto auth-form"> <h1 className="cool-title text-4xl font-bold text-center mb-8">Performans Paneli</h1> <h2 className="text-2xl font-bold text-center mb-6">{isLogin ? 'Giriş Yap' : 'Kayıt Ol'}</h2> <form onSubmit={handleSubmit} className="space-y-6"> <div><label className="block text-sm font-medium text-slate-400">E-posta Adresi</label><input type="email" value={email} onChange={e => setEmail(e.target.value)} required className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div> <div><label className="block text-sm font-medium text-slate-400">Şifre</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} required className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div> {error && <p className="text-red-400 text-sm text-center">{error}</p>} <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-slate-500">{loading ? 'İşleniyor...' : (isLogin ? 'Giriş Yap' : 'Kayıt Ol')}</button> </form> <p className="text-center text-slate-400 mt-6">{isLogin ? "Hesabınız yok mu? " : "Zaten bir hesabınız var mı? "}<button onClick={() => setIsLogin(!isLogin)} className="font-semibold text-blue-400 hover:underline">{isLogin ? 'Kayıt Olun' : 'Giriş Yapın'}</button></p> </div> );
        }
        
        const StudentAssessmentCard = memo(({ student, semester, onScoreChange }) => {
            const donemKey = semester === 1 ? 'donem1' : 'donem2';
            const assessment = student.assessments[donemKey];

            const calculatePerf1 = () => { const notes = [assessment.sozlu1, assessment.yazili1, assessment.sozlu2, assessment.yazili2]; const validNotes = notes.filter(n => n !== null && n !== '' && !isNaN(n)); if (validNotes.length === 0) return '-'; const sum = validNotes.reduce((acc, n) => acc + Number(n), 0); return Math.round(sum / validNotes.length); };
            const calculatePerf2 = () => { const bookNotes = [assessment.kitap1, assessment.kitap2]; const validBookNotes = bookNotes.filter(n => n !== null && n !== '' && !isNaN(n)); const gozlemNotu = (assessment.dersIciGozlem !== null && assessment.dersIciGozlem !== '' && !isNaN(assessment.dersIciGozlem)) ? Number(assessment.dersIciGozlem) : null; let kitapOrt = null; if (validBookNotes.length > 0) { const sum = validBookNotes.reduce((acc, n) => acc + Number(n), 0); kitapOrt = sum / validBookNotes.length; } if (kitapOrt !== null && gozlemNotu !== null) { return Math.round((kitapOrt + gozlemNotu) / 2); } else if (kitapOrt !== null) { return Math.round(kitapOrt); } else if (gozlemNotu !== null) { return gozlemNotu; } return '-'; };
            const perf1 = calculatePerf1();
            const perf2 = calculatePerf2();
            
            const NoteInput = ({ type, label }) => ( <div className="flex justify-between items-center space-x-2"> <label className="text-slate-400">{label}</label> <input type="number" defaultValue={assessment[type] === null ? '' : assessment[type]} onBlur={e => onScoreChange(student.id, donemKey, type, e.target.value)} className={`w-20 p-1.5 text-center bg-slate-700 rounded-md ${focusClasses}`} /> </div> );

            return ( <div className="bg-slate-800/50 rounded-lg p-4"> <h4 className="font-bold text-lg text-green-300 mb-3 p-2 border border-green-500 rounded-md bg-green-500/10">{student.name}</h4> <div className="flex flex-col space-y-4"> <div className="space-y-2 p-3 bg-slate-900/40 rounded-md"> <div className="flex justify-between items-center border-b border-slate-700 pb-2 mb-2"> <span className="font-bold text-sky-400">1. Performans Notu</span> <span className="font-bold text-xl text-sky-400">{perf1}</span> </div> <NoteInput type="sozlu1" label="1. Sözlü Görev" /> <NoteInput type="yazili1" label="1. Yazılı Görev" /> <NoteInput type="sozlu2" label="2. Sözlü Görev" /> <NoteInput type="yazili2" label="2. Yazılı Görev" /> </div> <div className="space-y-2 p-3 bg-slate-900/40 rounded-md"> <div className="flex justify-between items-center border-b border-slate-700 pb-2 mb-2"> <span className="font-bold text-sky-400">2. Performans Notu</span> <span className="font-bold text-xl text-sky-400">{perf2}</span> </div> <NoteInput type="kitap1" label="1. Kitap Sınavı" /> <NoteInput type="kitap2" label="2. Kitap Sınavı" /> <NoteInput type="dersIciGozlem" label="Ders İçi Gözlem" /> </div> </div> </div> );
        });

        const SemesterCard = ({ semester, students, bookTitles, onScoreChange, onBookTitleChange, onSave, onGenerateReport }) => {
            const [showSaveConfirm, setShowSaveConfirm] = useState(false);
            const handleSave = () => { onSave(); setShowSaveConfirm(true); setTimeout(() => setShowSaveConfirm(false), 2000); };
            return ( <div className="bg-slate-900/50 p-4 sm:p-6 rounded-lg border border-slate-700"> <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4"> <h3 className="text-xl font-bold text-blue-400">{semester}. Dönem Değerlendirmeleri</h3> <div className="flex items-center gap-2 sm:gap-4 w-full sm:w-auto"> {showSaveConfirm && <span className="text-green-400 teacher-info">Kaydedildi!</span>} <button onClick={handleSave} className="flex-grow sm:flex-grow-0 flex items-center justify-center gap-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><SaveIcon /> <span className="hidden sm:inline">Dönemi Kaydet</span></button> <button onClick={onGenerateReport} className="flex-grow sm:flex-grow-0 flex items-center justify-center gap-2 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500"><DownloadIcon /> <span className="hidden sm:inline">Rapor İndir</span></button> </div> </div> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6"> <div><label className="block text-sm font-medium text-slate-400">{semester}. Dönem 1. Kitap Adı</label><input type="text" value={bookTitles.kitap1} onChange={e => onBookTitleChange(semester === 1 ? 'donem1' : 'donem2', 'kitap1', e.target.value)} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md ${focusClasses}`}/></div> <div><label className="block text-sm font-medium text-slate-400">{semester}. Dönem 2. Kitap Adı</label><input type="text" value={bookTitles.kitap2} onChange={e => onBookTitleChange(semester === 1 ? 'donem1' : 'donem2', 'kitap2', e.target.value)} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md ${focusClasses}`}/></div> </div> <div className="space-y-3"> {students.map(student => ( <StudentAssessmentCard key={student.id} student={student} semester={semester} onScoreChange={onScoreChange} /> ))} </div> </div> );
        };
        
        const StudentScoreRow = memo(({ student, onUpdateScore, onManualChange, onDelete, onOpenNotes, calculateGrade }) => {
            return ( <div className="bg-slate-800/50 rounded-lg p-4 flex flex-col md:grid md:grid-cols-12 md:gap-4 md:items-center hover:bg-slate-700/50"> <div className="col-span-4 font-medium text-slate-100 flex items-center gap-2 mb-3 md:mb-0"> <button onClick={() => onDelete(student)} className="p-1 text-red-500/50 hover:text-red-500 hover:bg-red-500/10 rounded-full transition-colors"><TrashIcon/></button> {student.name} </div> <div className="flex flex-col gap-2 md:col-span-6 md:grid md:grid-cols-2 md:gap-4"> <div className="flex justify-between items-center py-2 border-t border-slate-700/50 md:border-none md:p-0 md:justify-center"> <span className="font-bold text-slate-400 md:hidden">Sınıf İçi:</span> <div className="flex items-center gap-1.5"> <button onClick={() => onUpdateScore(student.id, 'inClassPlus')} className="p-1.5 bg-green-500/20 text-green-300 rounded-full"><PlusIcon/></button> <input type="number" defaultValue={student.scores.inClassPlus} onBlur={(e) => onManualChange(student.id, 'inClassPlus', e.target.value)} className={`w-12 text-center bg-slate-700 rounded-md font-semibold text-green-400 ${focusClasses}`}/> <input type="number" defaultValue={student.scores.inClassMinus} onBlur={(e) => onManualChange(student.id, 'inClassMinus', e.target.value)} className={`w-12 text-center bg-slate-700 rounded-md font-semibold text-red-400 ${focusClasses}`}/> <button onClick={() => onUpdateScore(student.id, 'inClassMinus')} className="p-1.5 bg-red-500/20 text-red-300 rounded-full"><MinusIcon/></button> </div> </div> <div className="flex justify-between items-center py-2 border-t border-slate-700/50 md:border-none md:p-0 md:justify-center"> <span className="font-bold text-slate-400 md:hidden">Ödev:</span> <div className="flex items-center gap-1.5"> <button onClick={() => onUpdateScore(student.id, 'homeworkPlus')} className="p-1.5 bg-sky-500/20 text-sky-300 rounded-full"><PlusIcon/></button> <input type="number" defaultValue={student.scores.homeworkPlus} onBlur={(e) => onManualChange(student.id, 'homeworkPlus', e.target.value)} className={`w-12 text-center bg-slate-700 rounded-md font-semibold text-sky-400 ${focusClasses}`}/> <input type="number" defaultValue={student.scores.homeworkMinus} onBlur={(e) => onManualChange(student.id, 'homeworkMinus', e.target.value)} className={`w-12 text-center bg-slate-700 rounded-md font-semibold text-orange-400 ${focusClasses}`}/> <button onClick={() => onUpdateScore(student.id, 'homeworkMinus')} className="p-1.5 bg-orange-500/20 text-orange-300 rounded-full"><MinusIcon/></button> </div> </div> </div> <div className="flex justify-between items-center py-2 border-t border-slate-700/50 md:border-none md:p-0 md:col-span-1 md:justify-center"> <span className="font-bold text-slate-400 md:hidden">Notlar:</span> <button onClick={() => onOpenNotes(student)} className="p-2 text-slate-400 hover:text-white"><NoteIcon/></button> </div> <div className="flex justify-between items-center pt-3 mt-2 border-t border-blue-500/20 md:border-none md:p-0 md:col-span-1 md:justify-center"> <span className="font-bold text-slate-400 md:hidden">Sözlü Notu:</span> <div className="text-center font-bold text-2xl bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-cyan-300">{calculateGrade(student)}</div> </div> </div> );
        });

        function PerformancePanel({ user }) {
            const [activeView, setActiveView] = useState('classes');
            const [classes, setClasses] = useState([]);
            const [activeClassId, setActiveClassId] = useState(null);
            const [editingNoteStudent, setEditingNoteStudent] = useState(null);
            const [classToDelete, setClassToDelete] = useState(null);
            const [studentToDelete, setStudentToDelete] = useState(null);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [lastAction, setLastAction] = useState(null);
            const [undoMessage, setUndoMessage] = useState('');
            const [settings, setSettings] = useState({ teacherName: '', schoolName: '', branchName: '', inClassPlus: 2, inClassMinus: -1, homeworkPlus: 5, homeworkMinus: -3, baseScore: 70 });
            const [tempSettings, setTempSettings] = useState(settings);
            const [showSaveConfirmation, setShowSaveConfirmation] = useState(false);
            const [newClassName, setNewClassName] = useState('');
            const [newStudentName, setNewStudentName] = useState('');
            const [importText, setImportText] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [tempClassData, setTempClassData] = useState(null); 
            const [activeSemester, setActiveSemester] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            
            const activeClass = classes.find(c => c.id === activeClassId);

            const newAssessmentStructure = {
                donem1: { sozlu1: null, yazili1: null, sozlu2: null, yazili2: null, kitap1: null, kitap2: null, dersIciGozlem: null },
                donem2: { sozlu1: null, yazili1: null, sozlu2: null, yazili2: null, kitap1: null, kitap2: null, dersIciGozlem: null }
            };
            const newBookTitleStructure = {
                donem1: { kitap1: '', kitap2: '' },
                donem2: { kitap1: '', kitap2: '' }
            };
            
            useEffect(() => {
                if (user) {
                    setIsLoading(true);
                    const docRef = db.collection('userData').doc(user.uid);
                    const unsubscribe = docRef.onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            const migratedClasses = (data.classes || []).map(cls => {
                                const migratedStudents = (cls.students || []).map(student => {
                                    if (!student.assessments || !student.assessments.donem1?.hasOwnProperty('dersIciGozlem')) {
                                        const defaultAssess = JSON.parse(JSON.stringify(newAssessmentStructure));
                                        student.assessments = defaultAssess;
                                    }
                                    return student;
                                });
                                if (!cls.bookTitles) {
                                    cls.bookTitles = JSON.parse(JSON.stringify(newBookTitleStructure));
                                }
                                return { ...cls, students: migratedStudents };
                            });
                            setClasses(migratedClasses);
                            if (data.settings) { 
                                setSettings(data.settings); 
                                setTempSettings(data.settings); 
                            }
                        }
                        setIsLoading(false);
                    }, error => {
                        console.error("Veri dinlenirken hata oluştu:", error);
                        setIsLoading(false);
                    });
                    return () => unsubscribe();
                }
            }, [user]);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    if (!isLoading && user && activeView !== 'assessments') {
                        db.collection('userData').doc(user.uid).set({ classes, settings }, { merge: true })
                           .catch(error => console.error("Veri kaydedilirken hata oluştu:", error));
                    }
                }, 1500); 
                return () => clearTimeout(handler);
            }, [classes, settings, user, isLoading, activeView]);


            useEffect(() => {
                if (activeView === 'assessments' && activeClass) {
                    setTempClassData(JSON.parse(JSON.stringify(activeClass)));
                } else {
                    setTempClassData(null);
                }
                setSearchTerm('');
            }, [activeView, activeClassId, classes]);

            const handleSaveAssessments = useCallback(() => {
                const updatedClasses = classes.map(cls => cls.id === activeClassId ? tempClassData : cls);
                setClasses(updatedClasses);
                db.collection('userData').doc(user.uid).set({ classes: updatedClasses }, { merge: true });
            }, [classes, activeClassId, tempClassData, user]);

            const handleTempScoreChange = useCallback((studentId, donem, type, value) => {
                const newScore = value === '' ? null : Math.max(0, Math.min(100, Number(value)));
                setTempClassData(prev => {
                    if (!prev) return null;
                    const newStudents = prev.students.map(s => {
                        if (s.id !== studentId) return s;
                        const newAssessments = {
                            ...s.assessments,
                            [donem]: { ...s.assessments[donem], [type]: newScore }
                        };
                        return { ...s, assessments: newAssessments };
                    });
                    return { ...prev, students: newStudents };
                });
            }, []);

            const handleTempBookTitleChange = useCallback((donem, kitap, value) => {
                setTempClassData(prev => {
                    if (!prev) return null;
                    return {
                        ...prev,
                        bookTitles: {
                            ...prev.bookTitles,
                            [donem]: { ...prev.bookTitles[donem], [kitap]: value }
                        }
                    };
                });
            }, []);

            const handleGenerateSemesterReport = (semester) => {
                if (!tempClassData) return;
                setIsGeneratingPdf(true);
            
                const donemKey = semester === 1 ? 'donem1' : 'donem2';
                const calculatePerf1 = (assessment) => { const notes = [assessment.sozlu1, assessment.yazili1, assessment.sozlu2, assessment.yazili2]; const validNotes = notes.filter(n => n !== null && n !== '' && !isNaN(n)); if (validNotes.length === 0) return '-'; return Math.round(validNotes.reduce((a, b) => a + Number(b), 0) / validNotes.length); };
                const calculatePerf2 = (assessment) => { const bookNotes = [assessment.kitap1, assessment.kitap2]; const validBookNotes = bookNotes.filter(n => n !== null && n !== '' && !isNaN(n)); const gozlemNotu = (assessment.dersIciGozlem !== null && assessment.dersIciGozlem !== '' && !isNaN(assessment.dersIciGozlem)) ? Number(assessment.dersIciGozlem) : null; let kitapOrt = null; if (validBookNotes.length > 0) { kitapOrt = validBookNotes.reduce((a, b) => a + Number(b), 0) / validBookNotes.length; } if (kitapOrt !== null && gozlemNotu !== null) { return Math.round((kitapOrt + gozlemNotu) / 2); } else if (kitapOrt !== null) { return Math.round(kitapOrt); } else if (gozlemNotu !== null) { return gozlemNotu; } return '-'; };

                const reportHTML = `
                    <div style="padding: 20mm; color: black; font-family: sans-serif;">
                        <div style="text-align: center; margin-bottom: 10mm;">
                            <h1 style="font-size: 18px; font-weight: bold;">${settings.schoolName || 'OKUL ADI'}</h1>
                            <h2 style="font-size: 16px;">${tempClassData.name} Sınıfı ${semester}. Dönem Performans ve Sınav Raporu</h2>
                            <p style="font-size: 12px;">${settings.teacherName || 'Öğretmen'} - ${settings.branchName || 'Branş'}</p>
                        </div>
                        <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 5mm;">Kitaplar</h3>
                        <p style="font-size: 12px;"><b>1. Kitap:</b> ${tempClassData.bookTitles[donemKey].kitap1 || 'Belirtilmedi'}</p>
                        <p style="font-size: 12px;"><b>2. Kitap:</b> ${tempClassData.bookTitles[donemKey].kitap2 || 'Belirtilmedi'}</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9px; margin-top: 10mm;">
                            <thead>
                                <tr style="background-color: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Öğrenci Adı</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Sözlü-1</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Yazılı-1</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Sözlü-2</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Yazılı-2</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center; background-color: #e0f2fe;">Perf. Notu 1</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Kitap-1</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Kitap-2</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Gözlem</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: center; background-color: #e0f2fe;">Perf. Notu 2</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${tempClassData.students.map(student => {
                                const assessment = student.assessments[donemKey];
                                const perf1 = calculatePerf1(assessment);
                                const perf2 = calculatePerf2(assessment);
                                return `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 6px;">${student.name}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.sozlu1 !== null ? assessment.sozlu1 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.yazili1 !== null ? assessment.yazili1 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.sozlu2 !== null ? assessment.sozlu2 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.yazili2 !== null ? assessment.yazili2 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; background-color: #f0f9ff;">${perf1}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.kitap1 !== null ? assessment.kitap1 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.kitap2 !== null ? assessment.kitap2 : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${assessment.dersIciGozlem !== null ? assessment.dersIciGozlem : '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; background-color: #f0f9ff;">${perf2}</td>
                                </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                const reportContainer = document.createElement('div'); reportContainer.style.position = 'absolute'; reportContainer.style.left = '-9999px'; reportContainer.style.width = '297mm'; reportContainer.style.backgroundColor = 'white'; reportContainer.innerHTML = reportHTML; document.body.appendChild(reportContainer);
                window.html2canvas(reportContainer, { scale: 2, useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                    pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);
                    pdf.save(`${tempClassData.name} - ${semester}. Dönem Raporu.pdf`);
                    document.body.removeChild(reportContainer);
                    setIsGeneratingPdf(false);
                });
            };

            const handleAddClass = () => { if (newClassName.trim() === '') return; const newClass = { id: Date.now(), name: newClassName.trim(), students: [], bookTitles: JSON.parse(JSON.stringify(newBookTitleStructure)) }; setClasses(prev => [...prev, newClass]); setActiveClassId(newClass.id); setNewClassName(''); };
            const handleAddStudent = () => { if (newStudentName.trim() === '' || !activeClassId) return; const newStudent = { id: Date.now(), name: newStudentName.trim(), notes: '', scores: { inClassPlus: 0, inClassMinus: 0, homeworkPlus: 0, homeworkMinus: 0 }, assessments: JSON.parse(JSON.stringify(newAssessmentStructure)) }; setClasses(prev => prev.map(c => c.id === activeClassId ? { ...c, students: [...c.students, newStudent] } : c)); setNewStudentName(''); };
            const handleImport = () => { if (!activeClassId) return; const names = importText.split('\n').filter(name => name.trim() !== ''); const newStudents = names.map((name, index) => ({ id: Date.now() + index, name: name.trim(), notes: '', scores: { inClassPlus: 0, inClassMinus: 0, homeworkPlus: 0, homeworkMinus: 0 }, assessments: JSON.parse(JSON.stringify(newAssessmentStructure)) })); setClasses(prev => prev.map(c => c.id === activeClassId ? { ...c, students: [...c.students, ...newStudents] } : c )); setImportText(''); };
            
            const handleTempSettingsChange = (e) => {
                const { name, value } = e.target;
                const isNumeric = ['inClassPlus', 'inClassMinus', 'homeworkPlus', 'homeworkMinus', 'baseScore'].includes(name);
                setTempSettings(prev => ({ ...prev, [name]: isNumeric ? Number(value) : value }));
            };

            const handleSaveSettings = () => { setSettings(tempSettings); setShowSaveConfirmation(true); setTimeout(() => setShowSaveConfirmation(false), 2000); };
            const confirmDeleteClass = (classId) => { const updatedClasses = classes.filter(c => c.id !== classId); setClasses(updatedClasses); if (activeClassId === classId) { setActiveClassId(updatedClasses.length > 0 ? updatedClasses[0].id : null); } setClassToDelete(null); };
            const handleDeleteStudent = (studentId) => { if (!activeClassId) return; setClasses(prev => prev.map(c => c.id === activeClassId ? { ...c, students: c.students.filter(s => s.id !== studentId) } : c )); setStudentToDelete(null); };
            
            const calculateGrade = useCallback((student) => { if (!student || !student.scores) return 0; const score = settings.baseScore + (student.scores.inClassPlus * settings.inClassPlus) + (student.scores.inClassMinus * settings.inClassMinus) + (student.scores.homeworkPlus * settings.homeworkPlus) + (student.scores.homeworkMinus * settings.homeworkMinus); return Math.max(0, Math.min(100, score)); }, [settings]);
            
            const handleManualScoreChange = useCallback((studentId, scoreType, value) => {
                const scoreToSet = value === '' ? 0 : Math.max(0, Number(value));
                setClasses(prevClasses => prevClasses.map(c => {
                    if (c.id !== activeClassId) return c;
                    return {
                        ...c,
                        students: c.students.map(s => {
                            if (s.id !== studentId) return s;
                            const newScores = { ...s.scores, [scoreType]: scoreToSet };
                            return { ...s, scores: newScores };
                        })
                    };
                }));
            }, [activeClassId]);

            const updateStudentScore = useCallback((studentId, scoreType) => {
                setUndoMessage('');
                setLastAction({ studentId, scoreType, classId: activeClassId });
                setClasses(prevClasses => prevClasses.map(c => {
                    if (c.id !== activeClassId) return c;
                    return {
                        ...c,
                        students: c.students.map(s => {
                            if (s.id === studentId) {
                                const currentScore = Number(s.scores[scoreType]) || 0;
                                const newScore = currentScore + 1;
                                const newScores = { ...s.scores, [scoreType]: newScore };
                                return { ...s, scores: newScores };
                            }
                            return s;
                        })
                    };
                }));
            }, [activeClassId]);

            const handleSaveNote = (studentId, newNote) => { setClasses(prev => prev.map(c => { if (c.id !== activeClassId) return c; return { ...c, students: c.students.map(s => s.id === studentId ? { ...s, notes: newNote } : s )}; })); setEditingNoteStudent(null); };
            const handleUndoLastAction = () => { if (!lastAction) return; const { studentId, scoreType, classId } = lastAction; let studentName = ''; setClasses(prev => prev.map(c => { if (c.id !== classId) return c; return { ...c, students: c.students.map(s => { if (s.id === studentId && s.scores[scoreType] > 0) { studentName = s.name; return { ...s, scores: { ...s.scores, [scoreType]: s.scores[scoreType] - 1 } }; } return s; })}; })); setUndoMessage(`${studentName} isimli öğrencinin son puanı geri alındı.`); setLastAction(null); setTimeout(() => setUndoMessage(''), 3000); };
            const distributeScores = (totalScore, criteria) => { let distributed = {}; let currentTotal = 0; const scoresWithDiff = Object.entries(criteria).map(([key, { max }]) => { const rawScore = (totalScore / 100) * max; const roundedScore = Math.round(rawScore); currentTotal += roundedScore; return { key, max, rounded: roundedScore, diff: roundedScore - rawScore }; }); let difference = totalScore - currentTotal; scoresWithDiff.sort((a, b) => a.diff - b.diff); while (difference !== 0) { for (const item of scoresWithDiff) { if (difference === 0) break; if (difference > 0 && item.rounded < item.max) { item.rounded++; difference--; } else if (difference < 0 && item.rounded > 0) { item.rounded--; difference++; } } } scoresWithDiff.forEach(item => { distributed[item.key] = item.rounded; }); return distributed; };
            
            const handleGenerateSimplePdf = () => {
                if (!activeClass) return;
                setIsGeneratingPdf(true);
                const studentRows = activeClass.students.map(student => `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 8px;">${student.name}</td><td style="text-align: center; padding: 8px; font-weight: bold; font-size: 14px;">${calculateGrade(student)}</td></tr>`).join('');
                const reportHTML = `<div style="padding: 40px; color: black; font-family: sans-serif;"><div style="text-align: center;"><h1 style="font-size: 24px;">${settings.schoolName || 'OKUL ADI'}</h1><h2 style="font-size: 18px;">${activeClass.name} Performans Raporu</h2></div><table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 20px;"><thead><tr style="border-bottom: 2px solid #333;"><th style="text-align: left; padding: 8px;">Öğrenci Adı</th><th style="text-align: center; padding: 8px;">Sözlü Notu</th></tr></thead><tbody>${studentRows}</tbody></table><div style="position: absolute; bottom: 40px; right: 40px; text-align: right; font-size: 12px;"><p style="font-weight: bold;">${settings.teacherName || 'Öğretmen Adı'}</p><p>${settings.branchName || 'Branş'}</p></div></div>`;
                const reportContainer = document.createElement('div'); reportContainer.style.position = 'absolute'; reportContainer.style.left = '-9999px'; reportContainer.style.width = '210mm'; reportContainer.style.height = '297mm'; reportContainer.style.backgroundColor = 'white'; reportContainer.innerHTML = reportHTML; document.body.appendChild(reportContainer);
                window.html2canvas(reportContainer, { scale: 2, useCORS: true }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' }); pdf.addImage(imgData, 'PNG', 0, 0, 210, 297, undefined, 'FAST'); pdf.save(`${activeClass.name} - Basit Rapor.pdf`); document.body.removeChild(reportContainer); setIsGeneratingPdf(false); }).catch(err => { console.error("PDF oluşturma hatası:", err); document.body.removeChild(reportContainer); setIsGeneratingPdf(false); });
            };
            
            const handleGenerateDetailedPdf = () => {
                if (!activeClass) return;
                setIsGeneratingPdf(true);
                const reportContainer = document.createElement('div'); reportContainer.style.position = 'absolute'; reportContainer.style.left = '-9999px'; reportContainer.style.width = '210mm'; reportContainer.style.backgroundColor = 'white'; reportContainer.style.fontFamily = 'sans-serif'; reportContainer.style.color = 'black';
                let htmlContent = `<div style="padding: 20mm; box-sizing: border-box; width: 210mm; height: 297mm;"><div style="text-align: center; margin-bottom: 10mm;"><h1 style="font-size: 18px; font-weight: bold; margin: 0;">${settings.schoolName || 'OKUL ADI'}</h1><h2 style="font-size: 16px; margin: 5px 0;">${activeClass.name} Sınıfı Performans Raporu</h2><p style="font-size: 12px;">${settings.teacherName || 'Öğretmen'} - ${settings.branchName || 'Branş'}</p></div><h3 style="font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 2mm; margin-bottom: 5mm;">Genel Not Özeti</h3><table style="width: 100%; border-collapse: collapse; font-size: 10px;"><thead><tr style="background-color: #f2f2f2;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Öğrenci Adı</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Sözlü Notu</th></tr></thead><tbody>${activeClass.students.map(student => `<tr><td style="border: 1px solid #ddd; padding: 8px;">${student.name}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">${calculateGrade(student)}</td></tr>`).join('')}</tbody></table></div>`;
                activeClass.students.forEach(student => { const inClassPoints = (student.scores.inClassPlus * settings.inClassPlus) + (student.scores.inClassMinus * settings.inClassMinus); const homeworkPoints = (student.scores.homeworkPlus * settings.homeworkPlus) + (student.scores.homeworkMinus * settings.homeworkMinus); const dersIciRaporNotu = Math.round(Math.max(0, Math.min(100, settings.baseScore + (inClassPoints * 2)))); const performansOdeviRaporNotu = Math.round(Math.max(0, Math.min(100, settings.baseScore + (homeworkPoints * 2)))); const distributedInClass = distributeScores(dersIciRaporNotu, IN_CLASS_CRITERIA); const distributedPerformance = distributeScores(performansOdeviRaporNotu, PERFORMANCE_TASK_CRITERIA); htmlContent += `<div class="pdf-page-break" style="padding: 20mm; box-sizing: border-box; width: 210mm; height: 297mm;"><div style="text-align: center; margin-bottom: 10mm;"><h1 style="font-size: 18px; font-weight: bold; margin: 0;">${settings.schoolName || 'OKUL ADI'}</h1><h2 style="font-size: 16px; margin: 5px 0;">Öğrenci Detay Raporu</h2></div><p style="font-size: 12px; margin-bottom: 10mm;"><b>Öğrenci:</b> ${student.name}</p><h3 style="font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 2mm; margin-bottom: 5mm;">Ders İçi Gözlem Formu (Toplam: ${dersIciRaporNotu})</h3><table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 10mm;"><thead><tr style="background-color: #f2f2f2;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kriter</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Maks. Puan</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Alınan Puan</th></tr></thead><tbody>${Object.entries(IN_CLASS_CRITERIA).map(([key, { label, max }]) => `<tr><td style="border: 1px solid #ddd; padding: 8px;">${label}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${max}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${distributedInClass[key]}</td></tr>`).join('')}</tbody></table><h3 style="font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 2mm; margin-bottom: 5mm;">Performans Ödevi Formu (Toplam: ${performansOdeviRaporNotu})</h3><table style="width: 100%; border-collapse: collapse; font-size: 10px;"><thead><tr style="background-color: #f2f2f2;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kriter</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Maks. Puan</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Alınan Puan</th></tr></thead><tbody>${Object.entries(PERFORMANCE_TASK_CRITERIA).map(([key, { label, max }]) => `<tr><td style="border: 1px solid #ddd; padding: 8px;">${label}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${max}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${distributedPerformance[key]}</td></tr>`).join('')}</tbody></table></div>`; });
                reportContainer.innerHTML = htmlContent; document.body.appendChild(reportContainer); const pages = Array.from(reportContainer.children); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' }); const processPage = (index) => { if (index >= pages.length) { pdf.save(`${activeClass.name} - Detaylı Performans Raporu.pdf`); document.body.removeChild(reportContainer); setIsGeneratingPdf(false); return; } window.html2canvas(pages[index], { scale: 2, useCORS: true }).then(pageCanvas => { if (index > 0) pdf.addPage(); const imgData = pageCanvas.toDataURL('image/png'); pdf.addImage(imgData, 'PNG', 0, 0, 210, 297, undefined, 'FAST'); processPage(index + 1); }).catch(err => { console.error("PDF Sayfa oluşturma hatası:", err); setIsGeneratingPdf(false); }); }; processPage(0);
            };

            const NoteModal = ({ student, onSave, onClose }) => {
                const [note, setNote] = useState(student.notes);
                useEffect(() => {
                    const handleEsc = (event) => { if (event.keyCode === 27) onClose(); };
                    window.addEventListener('keydown', handleEsc);
                    return () => window.removeEventListener('keydown', handleEsc);
                }, [onClose]);
                return (<div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 confirm-modal"><div className="bg-slate-800 rounded-lg p-6 shadow-xl border border-slate-700 w-full max-w-lg mx-4"><h3 className="text-xl font-bold text-white mb-4">Notlar: <span className="text-blue-400">{student.name}</span></h3><textarea value={note} onChange={(e) => setNote(e.target.value)} className={`w-full h-48 p-3 bg-slate-700 border border-slate-600 rounded-md mb-4 text-white placeholder:text-slate-500 ${focusClasses}`} placeholder="Öğrenci ile ilgili notlarınızı buraya yazın..."></textarea><div className="flex justify-end gap-4"><button onClick={onClose} className="py-2 px-5 bg-slate-600 text-white rounded-lg hover:bg-slate-500 font-semibold">Kapat</button><button onClick={() => onSave(student.id, note)} className="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Kaydet</button></div></div></div>);
            };

            const filteredStudents = (list) => {
                if (!list) return [];
                return list.filter(student => student.name.toLowerCase().includes(searchTerm.toLowerCase()));
            };

            if(isLoading) return <div className="text-center text-white text-2xl">Veriler Yükleniyor...</div>;

            return (
                <Fragment>
                    <div className="w-full bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl shadow-2xl shadow-blue-500/10 p-4 sm:p-6 text-white pb-32">
                        <div className="mb-6 flex flex-col sm:flex-row justify-between items-start gap-4">
                             <div>
                                <h1 className="cool-title text-4xl font-bold">Performans Paneli</h1>
                                {settings.teacherName && (<div className="teacher-info mt-2 text-slate-400 text-sm"><span>{settings.teacherName}</span><span className="mx-2">|</span><span>{settings.branchName}</span><span className="mx-2">|</span><span>{settings.schoolName}</span></div>)}
                             </div>
                             <div className="flex flex-wrap gap-2 self-start sm:self-center">
                                <button onClick={() => setActiveView('classes')} className={`flex items-center gap-2 py-2 px-4 rounded-lg transition-colors ${activeView === 'classes' ? 'bg-blue-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}> <ClassesIcon /> Sınıflar </button>
                                <button onClick={() => setActiveView('assessments')} className={`flex items-center gap-2 py-2 px-4 rounded-lg transition-colors ${activeView === 'assessments' ? 'bg-blue-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}> <BookIcon /> Sınavlar ve Görevler </button>
                                <button onClick={() => setActiveView('settings')} className={`flex items-center gap-2 py-2 px-4 rounded-lg transition-colors ${activeView === 'settings' ? 'bg-blue-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}> <SettingsIcon /> Ayarlar </button>
                                <button onClick={() => auth.signOut()} className={`flex items-center gap-2 py-2 px-4 rounded-lg bg-red-600/80 hover:bg-red-600 text-white`}> <LogOutIcon /> Çıkış Yap </button>
                             </div>
                        </div>
                        
                        {activeView === 'settings' && (
                            <div className="confirm-modal">
                                <h2 className="text-2xl font-bold text-slate-100 mb-4">Genel Ayarlar</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-900/50 p-6 rounded-lg border border-slate-700">
                                    <div className="flex flex-col gap-4"><h3 className="font-bold text-lg text-blue-400 border-b border-slate-600 pb-2">Öğretmen Bilgileri</h3><div><label className="block text-sm font-medium text-slate-400">Ad Soyad</label><input type="text" name="teacherName" value={tempSettings.teacherName} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div><div><label className="block text-sm font-medium text-slate-400">Okul Adı</label><input type="text" name="schoolName" value={tempSettings.schoolName} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div><div><label className="block text-sm font-medium text-slate-400">Branş</label><input type="text" name="branchName" value={tempSettings.branchName} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div></div>
                                    <div className="flex flex-col gap-4"><h3 className="font-bold text-lg text-blue-400 border-b border-slate-600 pb-2">Puan Değerleri</h3><div><label className="block text-sm font-medium text-slate-400">Sınıf İçi Artı (+)</label><input type="number" name="inClassPlus" value={tempSettings.inClassPlus} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div><div><label className="block text-sm font-medium text-slate-400">Sınıf İçi Eksi (-)</label><input type="number" name="inClassMinus" value={tempSettings.inClassMinus} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div><div><label className="block text-sm font-medium text-slate-400">Ödev Artısı (+)</label><input type="number" name="homeworkPlus" value={tempSettings.homeworkPlus} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div><div><label className="block text-sm font-medium text-slate-400">Ödev Eksisi (-)</label><input type="number" name="homeworkMinus" value={tempSettings.homeworkMinus} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div></div>
                                    <div className="flex flex-col gap-4"><h3 className="font-bold text-lg text-blue-400 border-b border-slate-600 pb-2">Sözlü Notu</h3><div><label className="block text-sm font-medium text-slate-400">Başlangıç Notu</label><input type="number" name="baseScore" value={tempSettings.baseScore} onChange={handleTempSettingsChange} className={`w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/></div></div>
                                </div>
                                <div className="mt-6 flex justify-end items-center gap-4">{showSaveConfirmation && <span className="text-green-400 teacher-info">Kaydedildi!</span>}<button onClick={handleSaveSettings} className="flex items-center gap-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"><SaveIcon /> Ayarları Kaydet</button></div>
                            </div>
                        )}
                        
                        {activeView === 'assessments' && (
                            <div className="confirm-modal">
                                <div className="mb-6"><h2 className="text-xl font-bold text-slate-100 mb-3">Sınıf Seçimi</h2><div className="flex flex-wrap gap-2 border-b-2 border-slate-700 pb-4">{classes.length > 0 ? classes.map(c => <div key={c.id} className="relative"><button onClick={() => setActiveClassId(c.id)} className={`py-2 px-4 rounded-md ${activeClassId === c.id ? 'bg-blue-600 font-bold' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}>{c.name}</button></div>) : <p className="text-slate-400">Lütfen önce bir sınıf ekleyin.</p>}</div></div>
                                {tempClassData ? (
                                    <div>
                                        <div className="relative mb-6">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><SearchIcon /></div>
                                            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Öğrenci ara..." className={`w-full p-2 pl-10 bg-slate-800 border border-slate-600 rounded-md text-white ${focusClasses}`}/>
                                        </div>
                                        <div className="flex border-b border-slate-700 mb-6">
                                            <button onClick={() => setActiveSemester(1)} className={`py-2 px-4 font-semibold rounded-t-lg transition-colors ${activeSemester === 1 ? 'bg-slate-800 border-b-2 border-blue-500 text-white' : 'text-slate-400 hover:bg-slate-800/50'}`}>1. Dönem</button>
                                            <button onClick={() => setActiveSemester(2)} className={`py-2 px-4 font-semibold rounded-t-lg transition-colors ${activeSemester === 2 ? 'bg-slate-800 border-b-2 border-blue-500 text-white' : 'text-slate-400 hover:bg-slate-800/50'}`}>2. Dönem</button>
                                        </div>
                                        {activeSemester === 1 && <SemesterCard semester={1} students={filteredStudents(tempClassData.students)} bookTitles={tempClassData.bookTitles.donem1} onScoreChange={handleTempScoreChange} onBookTitleChange={handleTempBookTitleChange} onSave={handleSaveAssessments} onGenerateReport={() => handleGenerateSemesterReport(1)} />}
                                        {activeSemester === 2 && <SemesterCard semester={2} students={filteredStudents(tempClassData.students)} bookTitles={tempClassData.bookTitles.donem2} onScoreChange={handleTempScoreChange} onBookTitleChange={handleTempBookTitleChange} onSave={handleSaveAssessments} onGenerateReport={() => handleGenerateSemesterReport(2)} />}
                                    </div>
                                ) : <div className="text-center py-10"><h2 className="text-2xl font-bold text-slate-300">Lütfen İşlem Yapmak İçin Bir Sınıf Seçin</h2></div>}
                            </div>
                        )}

                        {activeView === 'classes' && (
                            <div>
                                <div className="mb-6"><h2 className="text-xl font-bold text-slate-100 mb-3">Sınıf Yönetimi</h2><div className="flex gap-2 mb-4"><input type="text" value={newClassName} onChange={(e) => setNewClassName(e.target.value)} placeholder="Yeni Sınıf Adı (örn: 11-B)" className={`flex-grow p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/> <button onClick={handleAddClass} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Ekle</button></div>{classes.length > 0 && <div className="flex flex-wrap gap-2 border-b-2 border-slate-700 pb-4">{classes.map(c => <div key={c.id} className="relative"><button onClick={() => setActiveClassId(c.id)} className={`py-2 px-4 rounded-md ${activeClassId === c.id ? 'bg-blue-600 font-bold' : 'bg-slate-700 hover:bg-slate-600 text-white'}`}>{c.name}</button><button onClick={() => setClassToDelete(c)} className="absolute -top-2 -right-2 bg-red-500/80 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs hover:bg-red-600">X</button></div>)}</div>}</div>
                                {activeClass ? (
                                    activeClass.students.length === 0 ? (
                                        <div className="bg-slate-900/50 border border-slate-700 rounded-lg p-6"><h2 className="text-xl font-bold mb-2 text-white">Öğrenci Listesini Aktar ({activeClass.name})</h2><textarea value={importText} onChange={(e) => setImportText(e.target.value)} placeholder={"1. Ali Yılmaz\n2. Ayşe Kaya..."} className={`w-full h-32 p-3 bg-slate-700 border border-slate-600 rounded-md mb-4 text-white ${focusClasses}`}/><button onClick={handleImport} className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700"><UploadCloudIcon /> Listeyi Oluştur</button></div>
                                    ) : (
                                        <div>
                                            <div className="relative mb-6">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><SearchIcon /></div>
                                                <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Öğrenci ara..." className={`w-full p-2 pl-10 bg-slate-800 border border-slate-600 rounded-md text-white ${focusClasses}`}/>
                                            </div>
                                            <div className="hidden md:grid grid-cols-12 gap-4 font-bold text-slate-400 p-2 border-b-2 border-slate-700 mb-2"><div className="col-span-4">Öğrenci Adı</div><div className="col-span-3 text-center">Sınıf İçi</div><div className="col-span-3 text-center">Ödev</div><div className="col-span-1 text-center">Notlar</div><div className="col-span-1 text-center">Sözlü Notu</div></div>
                                            <div className="space-y-2">{filteredStudents(activeClass.students).map(student => (
                                                <StudentScoreRow
                                                    key={student.id}
                                                    student={student}
                                                    onUpdateScore={updateStudentScore}
                                                    onManualChange={handleManualScoreChange}
                                                    onDelete={setStudentToDelete}
                                                    onOpenNotes={setEditingNoteStudent}
                                                    calculateGrade={calculateGrade}
                                                />
                                            ))}</div>
                                            <div className="mt-10 pt-6 border-t-2 border-slate-700"><h3 className="text-xl font-bold text-slate-100 mb-4">Öğrenci Yönetimi ({activeClass.name})</h3><div className="flex gap-2"><input type="text" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} placeholder="Yeni Öğrenci Adı Soyadı" className={`flex-grow p-2 bg-slate-700 border border-slate-600 rounded-md text-white ${focusClasses}`}/><button onClick={handleAddStudent} className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Ekle</button></div></div>
                                            <div className="flex flex-wrap justify-end items-center mt-8 gap-4">
                                                {undoMessage && <span className="text-green-400 teacher-info w-full text-right sm:w-auto">{undoMessage}</span>}
                                                <button onClick={handleUndoLastAction} disabled={!lastAction} className="flex items-center justify-center gap-2 bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed"><UndoIcon/> Geri Al</button>
                                                <button onClick={handleGenerateSimplePdf} disabled={isGeneratingPdf} className="flex items-center justify-center gap-2 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors disabled:bg-slate-500 disabled:cursor-wait"><DownloadIcon/> {isGeneratingPdf ? 'Oluşturuluyor...' : 'Basit Rapor İndir'}</button>
                                                <button onClick={handleGenerateDetailedPdf} disabled={isGeneratingPdf} className="flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-500 disabled:cursor-wait"><DownloadIcon/> {isGeneratingPdf ? 'Oluşturuluyor...' : 'Detaylı Rapor İndir'}</button>
                                            </div>
                                        </div>
                                    )
                                ) : <div className="text-center py-10"><h2 className="text-2xl font-bold text-slate-300">Hoş Geldiniz!</h2><p className="text-slate-400">Başlamak için bir sınıf ekleyin veya Ayarlar menüsünü düzenleyin.</p></div>}
                            </div>
                        )}
                    </div>
                    {classToDelete && (<div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 confirm-modal"><div className="bg-slate-800 rounded-lg p-8 shadow-xl border border-slate-700 mx-4"><h3 className="text-xl font-bold text-white mb-4">Sınıfı Silme Onayı</h3><p className="text-slate-300 mb-6">"<span className="font-bold">{classToDelete.name}</span>" sınıfını ve tüm verileri <br/> kalıcı olarak silmek istediğinizden emin misiniz?</p><div className="flex justify-end gap-4"><button onClick={() => setClassToDelete(null)} className="py-2 px-5 bg-slate-600 text-white rounded-lg hover:bg-slate-500 font-semibold">Hayır, Vazgeç</button><button onClick={() => confirmDeleteClass(classToDelete.id)} className="py-2 px-5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold">Evet, Sil</button></div></div></div>)}
                    {studentToDelete && (<div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 confirm-modal"><div className="bg-slate-800 rounded-lg p-8 shadow-xl border border-slate-700 mx-4"><h3 className="text-xl font-bold text-white mb-4">Öğrenci Silme Onayı</h3><p className="text-slate-300 mb-6">"<span className="font-bold">{studentToDelete.name}</span>" isimli öğrenciyi <br/> kalıcı olarak silmek istediğinizden emin misiniz?</p><div className="flex justify-end gap-4"><button onClick={() => setStudentToDelete(null)} className="py-2 px-5 bg-slate-600 text-white rounded-lg hover:bg-slate-500 font-semibold">Hayır, Vazgeç</button><button onClick={() => handleDeleteStudent(studentToDelete.id)} className="py-2 px-5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold">Evet, Sil</button></div></div></div>)}
                    {editingNoteStudent && <NoteModal student={editingNoteStudent} onSave={handleSaveNote} onClose={() => setEditingNoteStudent(null)} />}
                </Fragment>
            );
        }

        // Ana Uygulama Yöneticisi
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <div className="text-center text-white text-2xl">Yükleniyor...</div>;
            }

            return user ? <PerformancePanel user={user} /> : <AuthScreen />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

